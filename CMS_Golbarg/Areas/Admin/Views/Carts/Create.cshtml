@model CMS_Golbarg.ViewModel.CreateCartViewModel

@{
    ViewBag.Title = "Create";

}

@using (Html.BeginForm())
{

    @Html.AntiForgeryToken()
    @Html.HiddenFor(m => m.ActualHairColorID)
    @Html.HiddenFor(m => m.DestinationHairColorID)
    @Html.Hidden("State")

    

    <div id="smartwizard"  style="overflow-y: scroll;">
        <ul>
            <li><a href="#step-1">گام اول<br /><small>انتخاب رنگ موی مورد نظر</small></a></li>
            <li><a href="#step-2">گام دوم<br /><small>انتخاب رنگ موی فعلی</small></a></li>
            <li><a href="#step-3">گام سوم<br /><small>بررسی و اعلام نیاز به دکلره</small></a></li>
            <li><a href="#step-4">گام چهارم<br /><small>تایید نهایی و پرداخت</small></a></li>
        </ul>
 
        <div>
            <div id="step-1" class="col-xs-12">
                <div class="pay_step hide">
                <div class="alert alert-warning " id="infoAlert">با دقت به موارد انتخابی تایید نهایی را بزنید</div>
                    <div class="alert alert-danger " id="deColorAlert"></div>
                </div>
                <div class="card_content">
                    @foreach (var item in Model.HairColors)
                    {
                        @Html.Partial("~/Areas/Admin/Views/Shared/_HairColorCardViewForCartList.cshtml", item)
                    }
                </div>
                <div class="pay_step hide">
                    <button id="next" class="btn btn-success">تایید خرید و پرداخت از حساب</button>
                </div>
                </div>
            <div id="step-2" class="">
                
            </div>
            <div id="step-3" class="">
                
                
                
            </div>
            <div id="step-4" class="">
                <div class="alert alert-success" id="successAlert"></div>
            </div>
        </div>
    </div>
        
        @*<div class="col-xs-12">
            <div class="col-md-12 well text-center">
                <div class="box" id="HairColorBox" style="width: 100%;">
                    <div class="box-header with-border">
                        <h3 class="box-title">رنگ موی درخواستی خود را انتخاب کنید</h3>
                    </div>
                    <div class="box-body">*@
                        
        @* </div>
                    <div class="box-footer">
                        <button id="next" type="button" class="btn btn-success">بعدی</button>
                    </div>

                </div>*@


    





    



    


}

@section Scripts {
    <script>


        var ActualColorId = -1;
        var DestinationColorId = -1;
        var state = 0;
        var flag = true;
        var decolorFlagOk = false;
        var decolorSize = -1;






        $(document).ready(function () {

            var form = $('form');
                    var token = $('input[name="__RequestVerificationToken"]', form).val();


            $('#smartwizard').smartWizard({
                selected: 0,  // Initial selected step, 0 = first step 
                keyNavigation: false, // Enable/Disable keyboard navigation(left and right keys are used if enabled)
                autoAdjustHeight: false, // Automatically adjust content height
                cycleSteps: false, // Allows to cycle the navigation of steps
                backButtonSupport: false, // Enable the back button support
                useURLhash: true, // Enable selection of the step based on url hash
                //lang: {  // Language variables
                //    next: 'Next', 
                //    previous: 'Previous'
                //},
                toolbarSettings: {
                    toolbarPosition: 'none', // none, top, bottom, both
                    toolbarButtonPosition: 'right', // left, right
                    showNextButton: false, // show/hide a Next button
                    showPreviousButton: false, // show/hide a Previous button
                    //toolbarExtraButtons: [
                    //    $('<button></button>').text('Finish')
                    //    .addClass('btn btn-info')
                    //    .on('click', function(){ 
                    //        alert('Finsih button click');                            
                    //    }),
                    //    $('<button></button>').text('Cancel')
                    //    .addClass('btn btn-danger')
                    //    .on('click', function(){ 
                    //        alert('Cancel button click');                            
                    //    })
                    //]
                },
                anchorSettings: {
                    anchorClickable: false, // Enable/Disable anchor navigation
                    enableAllAnchors: false, // Activates all anchors clickable all times
                    markDoneStep: true, // add done css
                    enableAnchorOnDoneStep: true // Enable/Disable the done steps navigation
                },
                contentURL: null, // content url, Enables Ajax content loading. can set as data data-content-url on anchor
                disabledSteps: [],    // Array Steps disabled
                errorSteps: [],    // Highlight step with errors
                theme: 'default',//'default'   'circles'
                transitionEffect: 'fade', // Effect on navigation, none/slide/fade
                transitionSpeed: '400'

            });

            



            $("#smartwizard").on("showStep", function (e, anchorObject, stepNumber, stepDirection) {
                if (stepNumber === 2) {

                    $(".card_selected ").addClass("hide");
                    $(".card_selected ").addClass('ActualColor');
                    $('.card').removeClass("card_selected");
                    $('.card').addClass('hide');
                    $('.ActualColor').removeClass('hide');
                    $('.DestinationColor').removeClass('hide');
                    $('.DestinationColor>.card_btn').removeClass('hide');
                    $('.ActualColor>.card_btn').addClass('btn btn-success disabled').text('رنگ موی فعلی');
                    $('.DestinationColor>.card_btn').addClass('btn btn-success disabled')
                        .text('رنگ موی درخواستی');


                    $('.pay_step').removeClass('hide');
                    //$('#infoAlert').text('با دقت به موارد انتخابی تایید نهایی را بزنید ');
                    if (decolorSize !== -1) {
                        var decolormsg = "این ترکیب به دکلره با مقدار " + decolorSize + " نیاز دارد";
                        $('#deColorAlert').text(decolormsg);
                        $('#deColorAlert').show();
                    } else {
                        $('#deColorAlert').hide();
                    }
                    
                    //$('#next').text('تایید خرید و پرداخت از حساب').removeClass('hide');
                }
            });


            $(document).on('click', '.card', function () {
                if (state !== 3) {
                    if (flag) {

                        if (state < 3) {
                            $('.card').removeClass("card_selected");
                            $('.card_btn').addClass("hide");
                            $(this).addClass("card_selected");

                            $('.card_selected >.card_btn').removeClass("hide");
                        }
                        if (state ===0) {
                            DestinationColorId = $(".card_selected > #Id").val();
                            $('.card_selected >.card_btn').text('انتخاب رنگ درخواستی');
                        } else if (state === 1) {
                            ActualColorId = $(".card_selected > #Id").val();
                            $('.card_selected >.card_btn').text('انتخاب رنگ فعلی');
                        }
                    } else {
                        flag = true;
                    }
                }
            });


            $(document).on('click', '.card_btn', function () {
                flag = false;
                if (state === 0) {
                    //$('#DestinationHairColorID').val(DestinatioanColorId);
                    state = 1;
                    $(".card_selected ").addClass("hide");
                    $(".card_selected ").addClass('DestinationColor');
                    $('.card').removeClass("card_selected");
                    $('#step-2').html($('#step-1').html());
                    $('#step-2').addClass('col-xs-12');
                    $('#step-1').empty();
                    
                    $('#smartwizard').smartWizard("next");

                } else if (state === 1) {

                    $.ajax({
                        type: "POST",
                        url: "/Carts/get_DecolorState",
                        datatype: "Json",
                        data: {
                            __RequestVerificationToken: token,
                            DestinationHairColorID: DestinationColorId,
                            ActualHairColorID: ActualColorId
                        },
                        success: function (data) {
                            if (data.Item1) {


                                if (data.Item2 != null) {

                                    $("html, body").animate({
                                            scrollTop: 0
                                        },
                                        90);
                                    decolorSize = data.Item2;

                                    var msg = 'این ترکیب نیاز به دکلره با مقدار ' +
                                        decolorSize +
                                        ' دارد آیا مایل به ادامه خرید هستید؟';


                                    bootbox.confirm({
                                        message: msg,
                                        buttons: {
                                            confirm: {
                                                label: 'بله',
                                                className: 'btn-success'
                                            },
                                            cancel: {
                                                label: 'خیر',
                                                className: 'btn-danger'
                                            }
                                        },
                                        callback: function (result) {
                                            if (result) {
                                                state = 2;
                                                decolorFlagOk = true;
                                                $('#step-3').html($('#step-2').html());
                                                $('#step-3').addClass('col-xs-12');
                                                $('#step-2').empty();
                                                $('#smartwizard').smartWizard("next");
                                            } else {
                                                decolorFlagOk = false;
                                            }
                                            console.log('This was logged in the callback: ' + result);
                                        }
                                    });

                                } else {
                                    state = 2;
                                    $('#smartwizard').smartWizard("next");
                                }

                            } else {
                                var msg = 'برای این حالت فرمولی تعبیه نشده است';


                                bootbox.alert('<div class="alert alert-danger">' + msg + '</div>');
                            }
                        }
                    });
                }
                else if (state === 2)
                {
                    $('#infoAlert').removeClass('hide');
                    $('#infoAlert').text('با دقت به موارد انتخابی تایید نهایی را بزنید ');

                    state = 3;
                } else if (state === 3) {
                    //statefinish
                }
            });


            $(document).on('click', '#next', function () {
                if (state === 3) {
                    if (decolorFlagOk) {


                        $.ajax({
                            type: "POST",

                            url: "/Carts/Create",

                            datatype: "Json",

                            data: {
                                __RequestVerificationToken: token,
                                DestinationHairColorID: DestinationColorId,
                                ActualHairColorID: ActualColorId
                            },

                            success: function(data) {
                                var obj = JSON.stringify(data);
                                obj = JSON.parse(obj);

                                var msg = '<div class="box" id="modal" style="width: 100%;">' +
                                    '<div class="box-header  alert alert-success">' +
                                    '<h3 class="box-title">نتیجه خرید</h3>' +
                                    '</div>' +
                                    '<div class="box-body">' +
                                    obj.Mix +
                                    '</div>' +
                                    '</div>';
                                bootbox.alert(msg);
                            }


                        });
                    }
                } else if(state===2 && !decolorFlagOk && decolorSize >0 ) {
                    var msg = 'این ترکیب نیاز به دکلره با مقدار ' +
                        decolorSize +
                        ' دارد آیا مایل به ادامه خرید هستید؟';


                    bootbox.confirm({
                        message: msg,
                        buttons: {
                            confirm: {
                                label: 'بله',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'خیر',
                                className: 'btn-danger'
                            }
                        },
                        callback: function (result) {
                            if (result) {
                                state = 3;
                                decolorFlagOk = true;
                            } else {
                                decolorFlagOk = false;
                            }
                            console.log('This was logged in the callback: ' + result);
                        }
                    });
                }
            });
        });



    </script>
}
